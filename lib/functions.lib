##FUNCTIONS LIBRARY


setEnvironment(){
unset env
case "$1" in
        int-sp-ath.5gtango.eu)
		export env=int-sp-ath.5gtango.eu
            ;;
        pre-int-sp-ath.5gtango.eu)
		export env=pre-int-sp-ath.5gtango.eu
            ;;
	 qual-sp-bcn.5gtango.eu)
		export env=qual-sp-bcn.5gtango.eu
            ;;
	*)
		export env=int-sp-ath.5gtango.eu
	;;

esac

}

logger() {
  # Print logs to the stdout.
  # message
  echo "["$0"]" $(date -u +"%Y-%m-%dT%H:%M:%SZ") $1
}


cleanPackages(){
	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for clean packages"
		exit 1
	fi
	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for cleanPackages Function"		
		exit 1		
	else		
	        clean_packages="http://"$1":4011/catalogues/clean"
		Result=$(curl -s -X DELETE   "$clean_packages")	
		logger "Clean packages finished"		
	fi

}

getPackages() {

	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for get packages"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getPackages Function"		
		exit 1		
	else		
	        packages="http://"$1":32002/api/v3/packages"
		Result=$(curl -s "$packages")		
		logger "Get packages finished"
		
	fi
}



getService() {
	if [ $# != 4 ]
	then
		echo
		logger "Invalid number of arguments for get service"
		exit 1
	fi
	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getService"		
		exit 1		
	else	
		#logger "this is the env:  $1"	
	        services=$(curl -s http://"$1":32002/api/v3/services)
		#echo $services
		
		Service=$(echo $services | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.nsd.name==$NAME) 
				| select(.nsd.version==$VERSION)
				| select(.nsd.vendor==$VENDOR)
				')

		Service_uuid=$(echo $services | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.nsd.name==$NAME) 
				| select(.nsd.version==$VERSION)
				| select(.nsd.vendor==$VENDOR)
				| .uuid
				')

		Service_status=$(echo $services | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.nsd.name==$NAME) 
				| select(.nsd.version==$VERSION)
				| select(.nsd.vendor==$VENDOR)
				| .status
				')
		logger "Get service finished"		
	fi
}


getPackage() {
	if [ $# != 4 ]
	then
		echo
		logger "Invalid number of arguments for get package"
		exit 1
	fi
	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getPackage"		
		exit 1		
	else	
		#logger "this is the env:  $1"	
	        packages=$(curl -s http://"$1":32002/api/v3/packages)			
		
		Package=$(echo $packages | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.pd.name==$NAME) 
				| select(.pd.version==$VERSION)
				| select(.pd.vendor==$VENDOR)
				')		

		Package_uuid=$(echo $packages | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.pd.name==$NAME) 
				| select(.pd.version==$VERSION)
				| select(.pd.vendor==$VENDOR)
				| .uuid
				')

		Package_status=$(echo $packages | jq -r --arg NAME "$2" --arg VERSION "$3" --arg VENDOR "$4" '.[] 
				| select(.pd.name==$NAME) 
				| select(.pd.version==$VERSION)
				| select(.pd.vendor==$VENDOR)
				| .status
				')
		logger "Get package finished"		
	fi
}




uploadPackage() {
	if [ $# != 2 ]
	then
		echo
		logger "Invalid number of arguments for upload package"
		exit 1
	fi
	if [ -z "$1" ]
	then
		echo
		logger "Invalid environment for uploadPackage Function"		
		exit 1
	
	elif  [ ! -f "$2" ]
		then	
		echo
		logger "Cannot find the file for uploadPackage Function"		
		exit 1
	else				
		       #echo $1
		       #echo $2
		       upload="http://"$1":32002/api/v3/packages"
		       Result=$(curl -s -v -i -X POST  -F "package=@./$2" ""$upload"" 2>&1)
	       	       #echo $Result
		       logger "Upload package finished"	
	fi
}




getServices() {
	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getServices"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getServices Function"		
		exit 1		
	else	
	        services="http://"$1":32002/api/v3/services"
		Result=$(curl -s ""$services"")		
		logger "Get Services finished"		
	fi
}

getFunctions() {
	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getFunctions"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getFunctions"		
		exit 1		
	else	
	        functions="http://"$1":32002/api/v3/functions"
		Result=$(curl -s ""$functions"")		
		logger "Get Functions finished"		
	fi
}

getRequests() {
	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getRequests"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getRequests"		
		exit 1		
	else		
	        requests="http://"$1":32002/api/v3/requests"
		Result=$(curl -s ""$requests"")		
		logger "Get Functions finished"		
	fi
}

getSlices() {
	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getSlices"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getSlices"		
		exit 1		
	else	
	        slices="http://"$1":32002/api/v3/slices"
		Result=$(curl -s ""$slices"")		
		logger "Get Slices finished"		
	fi
}

getPolicies() {

	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getPolicies"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getPolicies Function"		
		exit 1		
	else	
	        policies="http://"$1":32002/api/v3/policies"
		Result=$(curl -s ""$policies"")	
		logger "Get Policies finished"		
	fi


}

getSlas() {

	if [ $# != 1 ]
	then
		echo
		logger "Invalid number of arguments for getSLAs"
		exit 1
	fi

	if [ -z "$1" ] 
	then
		echo
		logger "Invalid environment for getSLAs Function"		
		exit 1		
	else	
	        slas="http://"$1":32002/api/v3/slas/templates"
		Result=$(curl -s ""$slas"")	
		logger "Get SLAs finished"		
	fi


}




uploadPolicy() {
	
	########policy 
	upload=$(awk '/upload_policy/ {print $2}' envfile.yml)
	echo $upload
	
	# Create a new policy
	echo '------------------'
	echo 'Create a new policy'
	echo '------------------'
	
	Result=$(curl -X POST \
	  $upload \
	  -H 'cache-control: no-cache' \
	  -H 'content-type: application/json' \
	  -d '{"descriptor_schema": "https://raw.githubusercontent.com/sonata-nfv/tng-schema/master/policy-descriptor/policy-schema.yml","name": "samplepolicydemo123456","vendor": "tango","version": "0.2","network_service": {"vendor":"tango","name":"default-nsd","version": "0.9"},"policyRules": [{"name": "actionUponAlert1","salience": 1,"inertia":{"value": 30,"duration_unit": "m"},"conditions": {"condition": "AND","rules": [{"id":"vnf1.LogMetric","field":"vnf1.LogMetric","type": "string","input": "text","operator":"equal","value":"mon_rule_vm_cpu_perc"}]},"actions": [{"action_object":"ComponentResourceAllocationAction","action_type": "InfrastructureType","name": "ApplyFlavour","value": "3","target": "vnf1"}]},{"name": "highTranscodingRateRule","salience": 1,"inertia": {"value": 30,"duration_unit":"m"},"duration": {"value": 10,"duration_unit": "m"},"aggregation":"avg","conditions": {"condition":"AND","rules": [{"id": "vnf1.CPULoad","field": "vnf1.CPULoad","type": "double","input": "number","operator": "greater","value": "70"},{"id": "vnf2.RAM","field": "vnf2.RAM","type":"integer","input": "select","operator":"less","value": "8"}]},"actions":[{"action_object":"ComponentResourceAllocationAction","action_type":"InfrastructureType","name":"ApplyFlavour","value":"3","target": "vnf1"}]}]}'
	)
	
	echo 'Result'
}

instantiateNS (){
	#instantiating the NS
	instantiate=$(awk '/instantiate_ns/ {print $2}' envfile.yml)
	echo $instantiate	
	echo
	requesting="curl -v -i -H content-type:application/json -X POST ""$instantiate""  -d {"\"service_uuid"\":""$1""}"
	echo
	echo "this is the requesting curl:" 
	echo $requesting
	echo
	#instantiating=$(curl -s -v -i -H content-type:application/json -X POST ""$instantiate""  -d '{"\"service_uuid"\":""$1""}')
	instantiating=$($requesting)
	echo $instantiating
}


